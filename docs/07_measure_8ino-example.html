<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VivicoreSerial library: 07_measure.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VivicoreSerial library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">07_measure.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#define MIN_LIBRARY_VER_BUILD_NO (0x0012)</div>
<div class="line">#include &lt;VivicoreSerial.h&gt;</div>
<div class="line">#include &lt;Wire.h&gt;</div>
<div class="line">#include &lt;VL53L0X.h&gt;</div>
<div class="line"> </div>
<div class="line">// Use alghrythm to determine infinite distance</div>
<div class="line">#define INFINITE_ALGO_REFPWR (1)</div>
<div class="line">#define INFINITE_ALGO_HYST   (2)</div>
<div class="line">#define USE_INFINITE_ALGO    (INFINITE_ALGO_HYST)</div>
<div class="line"> </div>
<div class="line">// Uncomment this line to use long range mode. This</div>
<div class="line">// increases the sensitivity of the sensor and extends its</div>
<div class="line">// potential range, but increases the likelihood of getting</div>
<div class="line">// an inaccurate reading because of reflections from objects</div>
<div class="line">// other than the intended target. It works best in dark</div>
<div class="line">// conditions.</div>
<div class="line">#define LONG_RANGE</div>
<div class="line"> </div>
<div class="line">// Uncomment ONE of these two lines to get</div>
<div class="line">// - higher speed at the cost of lower accuracy OR</div>
<div class="line">// - higher accuracy at the cost of lower speed</div>
<div class="line">//#define HIGH_SPEED</div>
<div class="line">//#define HIGH_ACCURACY</div>
<div class="line">#if defined HIGH_SPEED</div>
<div class="line">#  define BUDGET_US (20000)</div>
<div class="line">#elif defined HIGH_ACCURACY</div>
<div class="line">#  define BUDGET_US (200000)</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">#if defined LONG_RANGE</div>
<div class="line">#  define MAX_VALUE (1000)</div>
<div class="line">#else</div>
<div class="line">#  define MAX_VALUE (300)</div>
<div class="line">#endif</div>
<div class="line">#define MIN_VALUE (0)</div>
<div class="line"> </div>
<div class="line">#define VALUE_ERROR_CORRECTION  (-47) // Average error measured by VIVIWARE JAPAN HW team</div>
<div class="line">#define VALUE_WITH_NO_DISTANCE  (80 + VALUE_ERROR_CORRECTION)</div>
<div class="line">#define VALUE_INFINITE          (8000 + VALUE_ERROR_CORRECTION)</div>
<div class="line">#define HYST_SIZE               (7)</div>
<div class="line">#define REFLECTION_POWER_THRESH (50)</div>
<div class="line"> </div>
<div class="line">#define REFLECTION_POWER_L (0x19)</div>
<div class="line">#define REFLECTION_POWER_H (0x18)</div>
<div class="line"> </div>
<div class="line">#define XSHUT_PIN      (10)</div>
<div class="line">#define T_BOOT_MS      (5) // tBOOT is 1.2ms max as written on VL53L0X DS</div>
<div class="line">#define ACK_TIMEOUT_MS (1000)</div>
<div class="line"> </div>
<div class="line">#define INTERVAL_MS (30)</div>
<div class="line"> </div>
<div class="line">enum rangeStat {</div>
<div class="line">  RANGE_STAT_VALID       = 0,</div>
<div class="line">  RANGE_STAT_FAIL_SIGMA  = 1,</div>
<div class="line">  RANGE_STAT_FAIL_SIGNAL = 2,</div>
<div class="line">  RANGE_STAT_FAIL_MIN    = 3,</div>
<div class="line">  RANGE_STAT_FAIL_PHASE  = 4,</div>
<div class="line">  RANGE_STAT_FAIL_HW     = 5,</div>
<div class="line">  RANGE_STAT_NONE        = 255,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">const uint8_t  USER_FW_MAJOR_VER = 0x00;</div>
<div class="line">const uint8_t  USER_FW_MINOR_VER = 0x0C;</div>
<div class="line">const uint16_t USER_FW_VER       = (((uint16_t)(USER_FW_MAJOR_VER) &lt;&lt; 8) + ((uint16_t)(USER_FW_MINOR_VER)));</div>
<div class="line">const uint32_t BRANCH_TYPE       = 0x00000007;</div>
<div class="line"> </div>
<div class="line">const dcInfo_t dcInfo[] = {</div>
<div class="line">  // {group_no, data_nature, data_type, data_min, data_max}</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_2BYTES, MIN_VALUE,</div>
<div class="line">   MAX_VALUE} // 1: Distance</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">VL53L0X sensor;</div>
<div class="line"> </div>
<div class="line">rangeStat getRangeStatus(void) {</div>
<div class="line">  // Refer to the ST official implementation of</div>
<div class="line">  // VL53L0X_get_pal_range_status() on vl53l0x_api_core.c</div>
<div class="line">  const uint8_t range_stat_reg      = sensor.readReg(VL53L0X::RESULT_RANGE_STATUS);</div>
<div class="line">  const uint8_t range_stat_internal = (range_stat_reg &amp; 0x78) &gt;&gt; 3;</div>
<div class="line">  const bool    none_flag = ((range_stat_internal == 0) || (range_stat_internal == 5) || (range_stat_internal == 7) ||</div>
<div class="line">                          (range_stat_internal == 12) || (range_stat_internal == 13) || (range_stat_internal == 14) ||</div>
<div class="line">                          (range_stat_internal == 15));</div>
<div class="line">  rangeStat     range_status = RANGE_STAT_VALID;</div>
<div class="line"> </div>
<div class="line">  if (none_flag) {</div>
<div class="line">    range_status = RANGE_STAT_NONE;</div>
<div class="line">  } else if (range_stat_internal == 1 || range_stat_internal == 2 || range_stat_internal == 3) {</div>
<div class="line">    range_status = RANGE_STAT_FAIL_HW;</div>
<div class="line">  } else if (range_stat_internal == 6 || range_stat_internal == 9) {</div>
<div class="line">    range_status = RANGE_STAT_FAIL_PHASE;</div>
<div class="line">    // TODO: Need more porting ST official driver</div>
<div class="line">    //  } else if (range_stat_internal == 8 ||</div>
<div class="line">    //        range_stat_internal == 10 ||</div>
<div class="line">    //        SignalRefClipflag == 1) {</div>
<div class="line">    //    range_status = RANGE_STAT_FAIL_MIN;</div>
<div class="line">    //  } else if (range_stat_internal == 4 ||</div>
<div class="line">    //        RangeIgnoreThresholdflag == 1) {</div>
<div class="line">    //    range_status = RANGE_STAT_FAIL_SIGNAL;</div>
<div class="line">    //  } else if (SigmaLimitflag == 1) {</div>
<div class="line">    //    range_status = RANGE_STAT_FAIL_SIGMA;</div>
<div class="line">  } else {</div>
<div class="line">    range_status = RANGE_STAT_VALID;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return range_status;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint16_t getUnofficialReflectionPower(void) {</div>
<div class="line">  uint16_t high_byte = sensor.readReg(REFLECTION_POWER_H);</div>
<div class="line">  uint16_t low_byte  = sensor.readReg(REFLECTION_POWER_L);</div>
<div class="line">  return ((high_byte &lt;&lt; 8) | low_byte);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">bool isNoTarget(const uint16_t raw_val) {</div>
<div class="line">  bool no_target = false;</div>
<div class="line"> </div>
<div class="line">#if defined(USE_INFINITE_ALGO)</div>
<div class="line">#  if (USE_INFINITE_ALGO == INFINITE_ALGO_REFPWR)</div>
<div class="line">  (void)raw_val; // Avoid static analysis warning</div>
<div class="line">  no_target = (getUnofficialReflectionPower() &lt; REFLECTION_POWER_THRESH);</div>
<div class="line">#  elif (USE_INFINITE_ALGO == INFINITE_ALGO_HYST)</div>
<div class="line">  static uint16_t raw_vals[HYST_SIZE] = {};</div>
<div class="line">  static uint8_t  raw_idx             = 0;</div>
<div class="line"> </div>
<div class="line">  raw_vals[raw_idx++] = raw_val;</div>
<div class="line">  raw_idx             = (raw_idx &gt;= HYST_SIZE) ? 0 : raw_idx;</div>
<div class="line">  for (uint8_t i = 0; i &lt; HYST_SIZE; i++) {</div>
<div class="line">    no_target |= (raw_vals[i] &gt; VALUE_INFINITE);</div>
<div class="line">  }</div>
<div class="line">#  endif</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">  return no_target;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void initSensor(void) {</div>
<div class="line">  Wire.end();</div>
<div class="line"> </div>
<div class="line">  digitalWrite(XSHUT_PIN, LOW);</div>
<div class="line">  pinMode(XSHUT_PIN, OUTPUT);</div>
<div class="line">  delay(100);</div>
<div class="line">  digitalWrite(XSHUT_PIN, HIGH);</div>
<div class="line">  delay(T_BOOT_MS);</div>
<div class="line"> </div>
<div class="line">  Wire.begin();</div>
<div class="line"> </div>
<div class="line">  sensor.init();</div>
<div class="line">  sensor.setTimeout(500);</div>
<div class="line"> </div>
<div class="line">#if defined LONG_RANGE</div>
<div class="line">  // lower the return signal rate limit (default is 0.25 MCPS)</div>
<div class="line">  sensor.setSignalRateLimit(0.1);</div>
<div class="line">  // increase laser pulse periods (defaults are 14 and 10 PCLKs)</div>
<div class="line">  sensor.setVcselPulsePeriod(VL53L0X::VcselPeriodPreRange, 18);</div>
<div class="line">  sensor.setVcselPulsePeriod(VL53L0X::VcselPeriodFinalRange, 14);</div>
<div class="line">#endif</div>
<div class="line">#if defined HIGH_SPEED || defined HIGH_ACCURACY</div>
<div class="line">  // increase/reduce timing budget (default is about 33 ms)</div>
<div class="line">  sensor.setMeasurementTimingBudget(BUDGET_US);</div>
<div class="line">#endif</div>
<div class="line">  sensor.startContinuous();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static void sendToCore(uint16_t val) {</div>
<div class="line">  Vivicore.write(1, val); // 1: Distance</div>
<div class="line">  Vivicore.flush();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  Vivicore.begin(BRANCH_TYPE, USER_FW_VER, dcInfo, countof(dcInfo), MIN_LIBRARY_VER_BUILD_NO);</div>
<div class="line">  initSensor();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  static unsigned long prevMills       = 0;</div>
<div class="line">  static unsigned long firstNoAckMills = 0;</div>
<div class="line">  unsigned long        curMills        = millis();</div>
<div class="line"> </div>
<div class="line">  if (curMills - prevMills &gt; INTERVAL_MS) {</div>
<div class="line">    static uint16_t presend_val  = 0;</div>
<div class="line">    const uint16_t  raw_read_val = sensor.readRangeContinuousMillimeters();</div>
<div class="line">    const uint16_t  raw_val =</div>
<div class="line">      (int32_t)raw_read_val + VALUE_ERROR_CORRECTION &lt; 0 ? 0 : raw_read_val + VALUE_ERROR_CORRECTION;</div>
<div class="line">    const bool has_ack    = !(sensor.last_status || sensor.timeoutOccurred());</div>
<div class="line">    uint16_t   send_val   = 0;</div>
<div class="line">    bool       ackTimeout = false;</div>
<div class="line"> </div>
<div class="line">    prevMills = curMills;</div>
<div class="line"> </div>
<div class="line">    if (!firstNoAckMills &amp;&amp; !has_ack) {</div>
<div class="line">      firstNoAckMills = curMills;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    if (firstNoAckMills) {</div>
<div class="line">      if (has_ack) {</div>
<div class="line">        firstNoAckMills = 0;</div>
<div class="line">      } else if (curMills - firstNoAckMills &gt; ACK_TIMEOUT_MS) {</div>
<div class="line">        ackTimeout      = true;</div>
<div class="line">        firstNoAckMills = 0;</div>
<div class="line">        initSensor();</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    if (has_ack) {</div>
<div class="line">      send_val = (isNoTarget(raw_val)) ? VALUE_INFINITE : raw_val;</div>
<div class="line">      if (send_val &gt; MAX_VALUE) {</div>
<div class="line">        send_val = MAX_VALUE;</div>
<div class="line">      } else if (send_val &lt; VALUE_WITH_NO_DISTANCE) {</div>
<div class="line">        send_val = MIN_VALUE;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      if (presend_val != send_val) {</div>
<div class="line">        presend_val = send_val;</div>
<div class="line">        sendToCore(send_val);</div>
<div class="line">      }</div>
<div class="line">    } else if (ackTimeout) {</div>
<div class="line">      // Resend last Measure distance to Core/App</div>
<div class="line">      sendToCore(presend_val);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    DebugPlainPrint0(curMills);</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(raw_read_val);</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(raw_val);</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(send_val);</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(getRangeStatus());</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(getUnofficialReflectionPower());</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrint0(has_ack);</div>
<div class="line">    DebugPlainPrint0(&quot;, &quot;);</div>
<div class="line">    DebugPlainPrintln0();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VivicoreSerial library: 05_rotator.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VivicoreSerial library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">05_rotator.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#define MIN_LIBRARY_VER_BUILD_NO (0x0012)</div>
<div class="line">#include &lt;VivicoreSerial.h&gt;</div>
<div class="line"> </div>
<div class="line">#define CHATTERING_WORKAROUND // Enable workaround to exclude chattering</div>
<div class="line"> </div>
<div class="line">#define PIN_PULSE_A (A0) // Hardware spec for FP1</div>
<div class="line">#define PIN_PULSE_B (A2) // Hardware spec for FP1</div>
<div class="line">#define PIN_SW      (2)  // Hardware spec for FP1</div>
<div class="line"> </div>
<div class="line">#define CNT_FIX_INTERVAL_MS (30)</div>
<div class="line">#define ABS_MAX             (100)</div>
<div class="line">#define MIN_VALUE           ((-1) * (ABS_MAX))</div>
<div class="line">#define MAX_VALUE           (ABS_MAX)</div>
<div class="line">#define INITIAL_VAL         (0)</div>
<div class="line"> </div>
<div class="line">#define DEFAULT_RESET (0)</div>
<div class="line">#define DEFAULT_WRAP  (1)</div>
<div class="line"> </div>
<div class="line">const uint8_t  USER_FW_MAJOR_VER = 0x01;</div>
<div class="line">const uint8_t  USER_FW_MINOR_VER = 0x01;</div>
<div class="line">const uint16_t USER_FW_VER       = (((uint16_t)(USER_FW_MAJOR_VER) &lt;&lt; 8) + ((uint16_t)(USER_FW_MINOR_VER)));</div>
<div class="line">const uint32_t BRANCH_TYPE       = 0x00000005; // Branch index number on vivitainc/ViviParts.git</div>
<div class="line"> </div>
<div class="line">const dcInfo_t dcInfo[] = {</div>
<div class="line">  // {group_no, data_nature, data_type, data_min, data_max}</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_BOOLEAN, 0, 1}, // 1: Button</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_1BYTE, MIN_VALUE, MAX_VALUE,</div>
<div class="line">   INITIAL_VAL},                                                                                     // 2: Value</div>
<div class="line">  {DcGroup_t::DC_GROUP_2, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_BOOLEAN, 0, 1, DEFAULT_RESET}, // 3: Reset</div>
<div class="line">  {DcGroup_t::DC_GROUP_2, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_BOOLEAN, 0, 1, DEFAULT_WRAP},  // 4: Wrap</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">static signed int encTable[0x10] = {};</div>
<div class="line"> </div>
<div class="line">typedef enum {</div>
<div class="line">  iButton = 1,</div>
<div class="line">  iValue,</div>
<div class="line">  iReset,</div>
<div class="line">  iWrap,</div>
<div class="line">} dcInfoIndex_t;</div>
<div class="line"> </div>
<div class="line">static void setEncTable(void) {</div>
<div class="line">  // Clockwise</div>
<div class="line">  encTable[B00000010] = +1;</div>
<div class="line">  encTable[B00001011] = +1;</div>
<div class="line">  encTable[B00001101] = +1;</div>
<div class="line">  encTable[B00000100] = +1;</div>
<div class="line">  // Counter-clockwise</div>
<div class="line">  encTable[B00000001] = -1;</div>
<div class="line">  encTable[B00000111] = -1;</div>
<div class="line">  encTable[B00001110] = -1;</div>
<div class="line">  encTable[B00001000] = -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static uint8_t getEncVal(void) {</div>
<div class="line">  static uint8_t encVal = 0;</div>
<div class="line"> </div>
<div class="line">  cli();</div>
<div class="line">  uint8_t pulseA = digitalRead(PIN_PULSE_A);</div>
<div class="line">  uint8_t pulseB = digitalRead(PIN_PULSE_B);</div>
<div class="line">  sei();</div>
<div class="line"> </div>
<div class="line">  encVal = (encVal &lt;&lt; 2) + ((pulseA &lt;&lt; 1) + pulseB);</div>
<div class="line">  return encVal;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static signed int processEncVal(const uint8_t encVal) {</div>
<div class="line">  signed int delta = 0;</div>
<div class="line">#if defined(CHATTERING_WORKAROUND)</div>
<div class="line">  signed int curDelta = encTable[encVal &amp; B00001111];</div>
<div class="line">  if (curDelta != 0) {</div>
<div class="line">    // Workaround to exclude chattering</div>
<div class="line">    if (curDelta * (-1) != encTable[(encVal &gt;&gt; 2) &amp; B00001111]) {</div>
<div class="line">      delta = curDelta;</div>
<div class="line">      if (delta &gt; 0) {</div>
<div class="line">        DebugBinPrint0(encVal);</div>
<div class="line">        DebugPlainPrintln0(&quot;,CW&quot;);</div>
<div class="line">      } else if (delta &lt; 0) {</div>
<div class="line">        DebugBinPrint0(encVal);</div>
<div class="line">        DebugPlainPrintln0(&quot;,CCW&quot;);</div>
<div class="line">      }</div>
<div class="line">    } else {</div>
<div class="line">      // DebugBinPrint0(encVal);</div>
<div class="line">      // DebugPlainPrintln0(&quot;,None&quot;);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">#else  // CHATTERING_WORKAROUND</div>
<div class="line">  switch (encVal &amp; B00001111) {</div>
<div class="line">  case B00000010:</div>
<div class="line">  case B00001011:</div>
<div class="line">  case B00001101:</div>
<div class="line">  case B00000100:</div>
<div class="line">    delta++;</div>
<div class="line">    DebugBinPrint0(encVal);</div>
<div class="line">    DebugPlainPrintln0(&quot;,CW&quot;);</div>
<div class="line">    break;</div>
<div class="line">  case B00000001:</div>
<div class="line">  case B00000111:</div>
<div class="line">  case B00001110:</div>
<div class="line">  case B00001000:</div>
<div class="line">    delta--;</div>
<div class="line">    DebugBinPrint0(encVal);</div>
<div class="line">    DebugPlainPrintln0(&quot;,CCW&quot;);</div>
<div class="line">    break;</div>
<div class="line">  default:</div>
<div class="line">    // DebugBinPrint0(encVal);</div>
<div class="line">    // DebugPlainPrintln0(&quot;,None&quot;);</div>
<div class="line">    break;</div>
<div class="line">  }</div>
<div class="line">#endif // CHATTERING_WORKAROUND</div>
<div class="line">  return delta;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static signed int adjustDelta(const signed int curDelta) {</div>
<div class="line">  static signed int prevDelta     = 0;</div>
<div class="line">  signed int        adjustedDelta = 0;</div>
<div class="line"> </div>
<div class="line">  if (curDelta != 0) {</div>
<div class="line">    if (prevDelta == curDelta) {</div>
<div class="line">      adjustedDelta = curDelta;</div>
<div class="line">      prevDelta     = 0;</div>
<div class="line">    } else {</div>
<div class="line">      prevDelta = curDelta;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return adjustedDelta;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static bool updateButton(void) {</div>
<div class="line">  static uint8_t prevButtonState = 0;</div>
<div class="line">  uint8_t        curButtonState  = 0;</div>
<div class="line">  bool           willSend        = false;</div>
<div class="line"> </div>
<div class="line">  curButtonState = !digitalRead(PIN_SW);</div>
<div class="line">  if (curButtonState != prevButtonState) {</div>
<div class="line">    DebugPlainPrint0(&quot;btn:&quot;);</div>
<div class="line">    DebugPlainPrint0(curButtonState);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    prevButtonState = curButtonState;</div>
<div class="line">    Vivicore.write(iButton, curButtonState);</div>
<div class="line">    willSend = true;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return willSend;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static void sendToCore(signed int delta, const bool resetOn, const bool wrapEnabled) {</div>
<div class="line">  bool              dbgOut     = false;</div>
<div class="line">  static signed int keptVal    = INITIAL_VAL;</div>
<div class="line">  static int8_t     prevSndVal = INITIAL_VAL;</div>
<div class="line"> </div>
<div class="line">  bool willSend = updateButton();</div>
<div class="line"> </div>
<div class="line">  if (delta != 0 || resetOn) {</div>
<div class="line">    int8_t sndVal = 0;</div>
<div class="line">    if (resetOn) {</div>
<div class="line">      keptVal = INITIAL_VAL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    DebugPlainPrint0(&quot;rst:&quot;);</div>
<div class="line">    DebugPlainPrint0(resetOn);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    DebugPlainPrint0(&quot;delta:&quot;);</div>
<div class="line">    DebugPlainPrint0(delta);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    delta = constrain(delta, MIN_VALUE, MAX_VALUE);</div>
<div class="line"> </div>
<div class="line">    keptVal += delta;</div>
<div class="line">    DebugPlainPrint0(&quot;keptVal:&quot;);</div>
<div class="line">    DebugPlainPrint0(keptVal);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">    DebugPlainPrint0(&quot;wrap=&quot;);</div>
<div class="line">    DebugPlainPrint0(wrapEnabled);</div>
<div class="line">    DebugPlainPrint0(&quot;:&quot;);</div>
<div class="line"> </div>
<div class="line">    if (abs(keptVal) &gt; ABS_MAX) {</div>
<div class="line">      if (wrapEnabled) {</div>
<div class="line">        const signed int sign           = (keptVal &lt; 0) ? -1 : +1;</div>
<div class="line">        const signed int signedLimitVal = sign * ABS_MAX;</div>
<div class="line">        const signed int outlyingVal    = (abs(keptVal) % ABS_MAX - 1) * sign;</div>
<div class="line">        keptVal                         = (-1) * signedLimitVal + outlyingVal;</div>
<div class="line">      } else {</div>
<div class="line">        keptVal = constrain(keptVal, MIN_VALUE, MAX_VALUE);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    sndVal = (int8_t)keptVal;</div>
<div class="line">    DebugPlainPrint0(&quot;sndVal:&quot;);</div>
<div class="line">    DebugPlainPrint0(sndVal);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    if (prevSndVal != sndVal || resetOn) {</div>
<div class="line">      prevSndVal = sndVal;</div>
<div class="line">      Vivicore.write(iValue, sndVal);</div>
<div class="line">      willSend = true;</div>
<div class="line">    }</div>
<div class="line">    dbgOut = true;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  if (willSend) {</div>
<div class="line">    Vivicore.flush();</div>
<div class="line">    DebugPlainPrint0(&quot;snt&quot;);</div>
<div class="line">    dbgOut = true;</div>
<div class="line">  }</div>
<div class="line">  if (dbgOut) {</div>
<div class="line">    DebugPlainPrintln0(&quot;&quot;);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static bool readFromCore(bool &amp;wrapEnabled) {</div>
<div class="line">  const AvailableNum_t cnt     = Vivicore.available();</div>
<div class="line">  bool                 resetOn = (bool)DEFAULT_RESET;</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; cnt.scaler; i++) {</div>
<div class="line">    const ScalerData_t scaler = Vivicore.read();</div>
<div class="line">    if (scaler.success) {</div>
<div class="line">      if (scaler.dc_n == iReset) {</div>
<div class="line">        resetOn = (bool)scaler.data;</div>
<div class="line">      } else if (scaler.dc_n == iWrap) {</div>
<div class="line">        wrapEnabled = (bool)scaler.data;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    DebugPlainPrint0(&quot;dc_n:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.dc_n);</div>
<div class="line">    DebugPlainPrint0(&quot;, success:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.success);</div>
<div class="line">    DebugPlainPrint0(&quot;, data:&quot;);</div>
<div class="line">    DebugPlainPrintln0(scaler.data);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return resetOn;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  Vivicore.begin(BRANCH_TYPE, USER_FW_VER, dcInfo, countof(dcInfo), MIN_LIBRARY_VER_BUILD_NO);</div>
<div class="line"> </div>
<div class="line">  pinMode(PIN_PULSE_A, INPUT);</div>
<div class="line">  pinMode(PIN_PULSE_B, INPUT);</div>
<div class="line">  pinMode(PIN_SW, INPUT);</div>
<div class="line"> </div>
<div class="line">  setEncTable();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  static signed int    delta        = 0;</div>
<div class="line">  static bool          wrapEnabled  = (bool)DEFAULT_WRAP;</div>
<div class="line">  static unsigned long prevMills    = 0;</div>
<div class="line">  unsigned long        curMills     = millis();</div>
<div class="line">  uint8_t              encVal       = 0;</div>
<div class="line">  signed int           instantDelta = 0;</div>
<div class="line"> </div>
<div class="line">  encVal       = getEncVal();</div>
<div class="line">  instantDelta = processEncVal(encVal);</div>
<div class="line">  delta += adjustDelta(instantDelta);</div>
<div class="line"> </div>
<div class="line">  // Dont care about millis overflows https://garretlab.web.fc2.com/arduino/lab/millis/</div>
<div class="line">  if (curMills - prevMills &gt; CNT_FIX_INTERVAL_MS) {</div>
<div class="line">    prevMills = curMills;</div>
<div class="line"> </div>
<div class="line">    bool resetOn = readFromCore(wrapEnabled);</div>
<div class="line">    sendToCore(delta, resetOn, wrapEnabled);</div>
<div class="line">    delta = 0;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>

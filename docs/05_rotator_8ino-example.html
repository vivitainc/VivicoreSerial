<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VivicoreSerial library: 05_rotator.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VivicoreSerial library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">05_rotator.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#define MIN_LIBRARY_VER_BUILD_NO (0x0012)</div>
<div class="line">#include &lt;VivicoreSerial.h&gt;</div>
<div class="line"> </div>
<div class="line">// #define CHATTERING_WORKAROUND // Enable workaround to exclude chattering</div>
<div class="line">// #define CHECK_PULSE_MISS_DETECTION // Enable check if pulse detection miss happens</div>
<div class="line"> </div>
<div class="line">#define HW_PIN_PULSE_A (A0)    // Hardware spec for FP1</div>
<div class="line">#define HW_PIN_PULSE_B (A2)    // Hardware spec for FP1</div>
<div class="line">#define HW_PORT_PULSES (PINC)  // Hardware spec for FP1 (PulseA &amp; PulseB)</div>
<div class="line">#define HW_BIT_PULSE_A (PINC0) // Hardware spec for FP1 (PulseA = A0 PC0)</div>
<div class="line">#define HW_BIT_PULSE_B (PINC2) // Hardware spec for FP1 (PulseB = A2 PC2)</div>
<div class="line">#define HW_PIN_SW      (2)     // Hardware spec for FP1</div>
<div class="line"> </div>
<div class="line">#define BIT_PULSE_A         (B00000010)</div>
<div class="line">#define BIT_PULSE_B         (B00000001)</div>
<div class="line">#define BITS_PULSE_A_B      (BIT_PULSE_A | BIT_PULSE_B)</div>
<div class="line">#define CLICK_PULSE         (BIT_PULSE_B) // BIT_PULSE_A or BIT_PULSE_B or BITS_PULSE_A_B to update countVal</div>
<div class="line">#define BITS_PRE_CUR_PULSES (B00001111)</div>
<div class="line"> </div>
<div class="line">#define CNT_FIX_INTERVAL_MS (30)</div>
<div class="line">#define ABS_MAX             (100)</div>
<div class="line">#define MIN_VALUE           ((-1) * (ABS_MAX))</div>
<div class="line">#define MAX_VALUE           (ABS_MAX)</div>
<div class="line">#define INITIAL_VAL         (0)</div>
<div class="line"> </div>
<div class="line">#define DEFAULT_RESET (0)</div>
<div class="line">#define DEFAULT_WRAP  (1)</div>
<div class="line"> </div>
<div class="line">#define TIMER_TRIGGER_US    (256L) // (1024L)</div>
<div class="line">#define TIMER_TRIGGER_COUNT (TIMER_TRIGGER_US * ((F_CPU / 1L) / 1000L / 1000L))</div>
<div class="line"> </div>
<div class="line">const uint8_t  USER_FW_MAJOR_VER = 0x01;</div>
<div class="line">const uint8_t  USER_FW_MINOR_VER = 0x02;</div>
<div class="line">const uint16_t USER_FW_VER       = (((uint16_t)(USER_FW_MAJOR_VER) &lt;&lt; 8) + ((uint16_t)(USER_FW_MINOR_VER)));</div>
<div class="line">const uint32_t BRANCH_TYPE       = 0x00000005; // Branch index number on vivitainc/ViviParts.git</div>
<div class="line"> </div>
<div class="line">const dcInfo_t dcInfo[] = {</div>
<div class="line">  // {group_no, data_nature, data_type, data_min, data_max}</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_BOOLEAN, 0, 1}, // 1: Button</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_1BYTE, MIN_VALUE, MAX_VALUE,</div>
<div class="line">   INITIAL_VAL},                                                                                     // 2: Value</div>
<div class="line">  {DcGroup_t::DC_GROUP_2, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_BOOLEAN, 0, 1, DEFAULT_RESET}, // 3: Reset</div>
<div class="line">  {DcGroup_t::DC_GROUP_2, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_BOOLEAN, 0, 1, DEFAULT_WRAP},  // 4: Wrap</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">static signed int          encTable[0x10] = {};</div>
<div class="line">static volatile signed int countVal       = INITIAL_VAL;</div>
<div class="line">static volatile bool       wrapEnabled    = (bool)DEFAULT_WRAP;</div>
<div class="line"> </div>
<div class="line">typedef enum {</div>
<div class="line">  iButton = 1,</div>
<div class="line">  iValue,</div>
<div class="line">  iReset,</div>
<div class="line">  iWrap,</div>
<div class="line">} dcInfoIndex_t;</div>
<div class="line"> </div>
<div class="line">#if defined(CHECK_PULSE_MISS_DETECTION)</div>
<div class="line">struct RotateEle_t {</div>
<div class="line">  uint8_t right;</div>
<div class="line">  uint8_t left;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">RotateEle_t rotate[B100] = {};</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">static inline void setEncTable(void) {</div>
<div class="line">  // Clockwise</div>
<div class="line">  encTable[B00000010] = +1;</div>
<div class="line">  encTable[B00001011] = +1;</div>
<div class="line">  encTable[B00001101] = +1;</div>
<div class="line">  encTable[B00000100] = +1;</div>
<div class="line">  // Counter-clockwise</div>
<div class="line">  encTable[B00000001] = -1;</div>
<div class="line">  encTable[B00000111] = -1;</div>
<div class="line">  encTable[B00001110] = -1;</div>
<div class="line">  encTable[B00001000] = -1;</div>
<div class="line"> </div>
<div class="line">#if defined(CHECK_PULSE_MISS_DETECTION)</div>
<div class="line">  // Clockwise</div>
<div class="line">  rotate[B00].right = B10;</div>
<div class="line">  rotate[B10].right = B11;</div>
<div class="line">  rotate[B11].right = B01;</div>
<div class="line">  rotate[B01].right = B00;</div>
<div class="line">  // Counter-clockwise</div>
<div class="line">  rotate[B00].left = B01;</div>
<div class="line">  rotate[B10].left = B00;</div>
<div class="line">  rotate[B11].left = B10;</div>
<div class="line">  rotate[B01].left = B11;</div>
<div class="line">#endif</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline signed int adjustForClick(const signed int curDelta, const uint8_t encVal) {</div>
<div class="line">  signed int     adjustedDelta = 0;</div>
<div class="line">  const uint8_t  curPulse      = encVal &amp; CLICK_PULSE;</div>
<div class="line">  static uint8_t prePulse      = curPulse;</div>
<div class="line"> </div>
<div class="line">  if (prePulse != curPulse) {</div>
<div class="line">    prePulse      = curPulse;</div>
<div class="line">    adjustedDelta = curDelta;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return adjustedDelta;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline uint8_t getEncVal(void) {</div>
<div class="line">  static uint8_t encVal = 0;</div>
<div class="line"> </div>
<div class="line">  // cli(); // no needed as this function is called in interrupt</div>
<div class="line">  const uint8_t regPortC = HW_PORT_PULSES;</div>
<div class="line">  const uint8_t pulseA   = bitRead(regPortC, HW_BIT_PULSE_A); // digitalRead(HW_PIN_PULSE_A);</div>
<div class="line">  const uint8_t pulseB   = bitRead(regPortC, HW_BIT_PULSE_B); // digitalRead(HW_PIN_PULSE_B);</div>
<div class="line">  // sei(); // no needed as this function is called in interrupt</div>
<div class="line"> </div>
<div class="line">  const uint8_t curEncVal = (pulseA &lt;&lt; 1) + pulseB;</div>
<div class="line">  encVal                  = (encVal &lt;&lt; 2) + curEncVal;</div>
<div class="line"> </div>
<div class="line">  return encVal;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline signed int fixCount(const signed int val) {</div>
<div class="line">  signed int fixVal = val;</div>
<div class="line">  if (val &lt; MIN_VALUE || val &gt; MAX_VALUE) {</div>
<div class="line">    if (wrapEnabled) {</div>
<div class="line">      if (val &lt; MIN_VALUE) {</div>
<div class="line">        fixVal = MAX_VALUE - (abs(val - MIN_VALUE) - 1);</div>
<div class="line">      } else if (val &gt; MAX_VALUE) {</div>
<div class="line">        fixVal = MIN_VALUE + (abs(val - MAX_VALUE) - 1);</div>
<div class="line">      }</div>
<div class="line">    } else {</div>
<div class="line">      fixVal = constrain(val, MIN_VALUE, MAX_VALUE);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  return fixVal;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void processEncVal(void) {</div>
<div class="line">  const uint8_t    encVal   = getEncVal();</div>
<div class="line">  const signed int curDelta = encTable[encVal &amp; BITS_PRE_CUR_PULSES];</div>
<div class="line"> </div>
<div class="line">  static uint8_t preEncVal = 0;</div>
<div class="line">  const uint8_t  prePulses = preEncVal &amp; BITS_PULSE_A_B;</div>
<div class="line">  const uint8_t  curPulses = encVal &amp; BITS_PULSE_A_B;</div>
<div class="line"> </div>
<div class="line">  if (prePulses == curPulses) {</div>
<div class="line">    // no need to update countVal if no pulse state change</div>
<div class="line">    return;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">#if defined(CHECK_PULSE_MISS_DETECTION)</div>
<div class="line">  if (rotate[prePulses].left != curPulses &amp;&amp; rotate[prePulses].right != curPulses) {</div>
<div class="line">    // miss detection of a pulse edge</div>
<div class="line">    DebugPlainPrintln0(&quot;+&quot;);</div>
<div class="line">    DebugGPIOHigh(PORTC, 4); // debug A4 PC4</div>
<div class="line">    DebugGPIOLow(PORTC, 4);  // debug A4 PC4</div>
<div class="line">  }</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">  preEncVal = encVal;</div>
<div class="line"> </div>
<div class="line">  if (curDelta != 0) {</div>
<div class="line">#if defined(CHATTERING_WORKAROUND)</div>
<div class="line">    // Workaround to exclude chattering</div>
<div class="line">    if (curDelta * (-1) == encTable[(encVal &gt;&gt; 2) &amp; BITS_PRE_CUR_PULSES]) {</div>
<div class="line">      return;</div>
<div class="line">    }</div>
<div class="line">#endif</div>
<div class="line">    if (curDelta &gt; 0) {</div>
<div class="line">      DebugBinPrint0(encVal);</div>
<div class="line">      DebugPlainPrintln0(&quot;,CW&quot;);</div>
<div class="line">    } else if (curDelta &lt; 0) {</div>
<div class="line">      DebugBinPrint0(encVal);</div>
<div class="line">      DebugPlainPrintln0(&quot;,CCW&quot;);</div>
<div class="line">    }</div>
<div class="line">    const signed int delta = adjustForClick(curDelta, encVal);</div>
<div class="line">    countVal += delta;</div>
<div class="line">    countVal = fixCount(countVal);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">ISR(TIMER4_COMPA_vect) {</div>
<div class="line">  DebugGPIOHigh(PORTC, 5); // debug A5 PC5</div>
<div class="line">  processEncVal();</div>
<div class="line">  DebugGPIOLow(PORTC, 5); // debug A5 PC5</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static bool updateButton(void) {</div>
<div class="line">  static uint8_t prevButtonState = 0;</div>
<div class="line">  const uint8_t  curButtonState  = !digitalRead(HW_PIN_SW);</div>
<div class="line">  bool           willSend        = false;</div>
<div class="line"> </div>
<div class="line">  if (curButtonState != prevButtonState) {</div>
<div class="line">    DebugPlainPrint0(&quot;btn:&quot;);</div>
<div class="line">    DebugPlainPrint0(curButtonState);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    prevButtonState = curButtonState;</div>
<div class="line">    Vivicore.write(iButton, curButtonState);</div>
<div class="line">    willSend = true;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return willSend;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static void sendToCore(const signed int curVal, const bool resetOn, const bool wrapEnabled) {</div>
<div class="line">  static int8_t prevSndVal = INITIAL_VAL;</div>
<div class="line">  const int8_t  sndVal     = (int8_t)curVal;</div>
<div class="line"> </div>
<div class="line">  bool willSend = updateButton();</div>
<div class="line"> </div>
<div class="line">  if (prevSndVal != sndVal || resetOn) {</div>
<div class="line">    DebugPlainPrint0(&quot;wrap=&quot;);</div>
<div class="line">    DebugPlainPrint0(wrapEnabled);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">    DebugPlainPrint0(&quot;rst=&quot;);</div>
<div class="line">    DebugPlainPrint0(resetOn);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">    DebugPlainPrint0(&quot;sndVal=&quot;);</div>
<div class="line">    DebugPlainPrint0(sndVal);</div>
<div class="line">    DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line"> </div>
<div class="line">    prevSndVal = sndVal;</div>
<div class="line">    Vivicore.write(iValue, sndVal);</div>
<div class="line">    willSend = true;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  if (willSend) {</div>
<div class="line">    Vivicore.flush();</div>
<div class="line">    DebugPlainPrint0(&quot;snt&quot;);</div>
<div class="line">    DebugPlainPrintln0(&quot;&quot;);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static bool readFromCore(void) {</div>
<div class="line">  const AvailableNum_t cnt     = Vivicore.available();</div>
<div class="line">  bool                 resetOn = (bool)DEFAULT_RESET;</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; cnt.scaler; i++) {</div>
<div class="line">    const ScalerData_t scaler = Vivicore.read();</div>
<div class="line">    if (scaler.success) {</div>
<div class="line">      if (scaler.dc_n == iReset) {</div>
<div class="line">        resetOn = (bool)scaler.data;</div>
<div class="line">      } else if (scaler.dc_n == iWrap) {</div>
<div class="line">        wrapEnabled = (bool)scaler.data;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    DebugPlainPrint0(&quot;dc_n:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.dc_n);</div>
<div class="line">    DebugPlainPrint0(&quot;, success:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.success);</div>
<div class="line">    DebugPlainPrint0(&quot;, data:&quot;);</div>
<div class="line">    DebugPlainPrintln0(scaler.data);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return resetOn;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static void startTimer4Interrupt() {</div>
<div class="line">  // Timer 4 settings</div>
<div class="line">  TCCR4A = 0;</div>
<div class="line">  TCCR4B = bit(WGM42) | bit(CS40); // CTC mode, No prescaling</div>
<div class="line">  OCR4A  = TIMER_TRIGGER_COUNT;    // ISR trigger counter value</div>
<div class="line">  TIMSK4 = bit(OCIE4A);            // Output Compare A Match Interrupt Enable</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  Vivicore.begin(BRANCH_TYPE, USER_FW_VER, dcInfo, countof(dcInfo), MIN_LIBRARY_VER_BUILD_NO);</div>
<div class="line"> </div>
<div class="line">  pinMode(HW_PIN_PULSE_A, INPUT);</div>
<div class="line">  pinMode(HW_PIN_PULSE_B, INPUT);</div>
<div class="line">  pinMode(HW_PIN_SW, INPUT);</div>
<div class="line"> </div>
<div class="line">  setEncTable();</div>
<div class="line"> </div>
<div class="line">  DebugGPIODirectOut(DDRC, 5); // debug A5 PC5</div>
<div class="line">  DebugGPIOLow(PORTC, 5);      // debug A5 PC5</div>
<div class="line">  DebugGPIODirectOut(DDRC, 4); // debug A4 PC4</div>
<div class="line">  DebugGPIOLow(PORTC, 4);      // debug A4 PC4</div>
<div class="line"> </div>
<div class="line">  startTimer4Interrupt();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  static unsigned long prevMills = 0;</div>
<div class="line">  const unsigned long  curMills  = millis();</div>
<div class="line"> </div>
<div class="line">  // Dont care about millis overflows https://garretlab.web.fc2.com/arduino/lab/millis/</div>
<div class="line">  if (curMills - prevMills &gt; CNT_FIX_INTERVAL_MS) {</div>
<div class="line">    prevMills = curMills;</div>
<div class="line"> </div>
<div class="line">    const bool resetOn = readFromCore();</div>
<div class="line"> </div>
<div class="line">    cli();</div>
<div class="line">    if (resetOn) {</div>
<div class="line">      countVal = INITIAL_VAL;</div>
<div class="line">    }</div>
<div class="line">    const signed int curVal = countVal;</div>
<div class="line">    sei();</div>
<div class="line"> </div>
<div class="line">    sendToCore(curVal, resetOn, wrapEnabled);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>

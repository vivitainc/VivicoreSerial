<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VivicoreSerial library: 0B_led.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VivicoreSerial library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">0B_led.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#define MIN_LIBRARY_VER_BUILD_NO (0x0012)</div>
<div class="line">#include &lt;VivicoreSerial.h&gt;</div>
<div class="line"> </div>
<div class="line">#define LED_HZ          (1000)</div>
<div class="line">#define LED_VCC_HZ      (32 * 1000)</div>
<div class="line">#define MAX_LIGHT_8BIT  (0xFF)</div>
<div class="line">#define MAX_LIGHT_16BIT (F_CPU / LED_HZ)</div>
<div class="line">#define DEFAULT_LIGHT   (0)</div>
<div class="line">#if defined(BOARD_REV) &amp;&amp; (BOARD_REV &gt;= BOARD_REV_FP1_DVT)</div>
<div class="line">#  define MAX_LIGHT_R (6234)           // For 5500K white</div>
<div class="line">#  define MAX_LIGHT_G (6909)           // For 5500K white</div>
<div class="line">#  define MAX_LIGHT_B (MAX_LIGHT_8BIT) // For 5500K white</div>
<div class="line">#else</div>
<div class="line">#  define MAX_LIGHT_R (MAX_LIGHT_8BIT)</div>
<div class="line">#  define MAX_LIGHT_G (MAX_LIGHT_16BIT)</div>
<div class="line">#  define MAX_LIGHT_B (MAX_LIGHT_16BIT)</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">#define LED_VCC_PIN (2)</div>
<div class="line">#if defined(BOARD_REV) &amp;&amp; (BOARD_REV &gt;= BOARD_REV_FP1_DVT)</div>
<div class="line">#  define LED_R_PIN (9)</div>
<div class="line">#  define LED_G_PIN (10)</div>
<div class="line">#  define LED_B_PIN (3)</div>
<div class="line">#else</div>
<div class="line">#  define LED_R_PIN (3)</div>
<div class="line">#  define LED_G_PIN (10)</div>
<div class="line">#  define LED_B_PIN (9)</div>
<div class="line">#endif</div>
<div class="line">#define N_RGB     (3)</div>
<div class="line">#define EXP_GAMMA ((float)2.2)</div>
<div class="line"> </div>
<div class="line">const uint8_t  USER_FW_MAJOR_VER = 0x00;</div>
<div class="line">const uint8_t  USER_FW_MINOR_VER = 0x12;</div>
<div class="line">const uint16_t USER_FW_VER       = (((uint16_t)(USER_FW_MAJOR_VER) &lt;&lt; 8) + ((uint16_t)(USER_FW_MINOR_VER)));</div>
<div class="line">const uint32_t BRANCH_TYPE       = 0x0000000B; // Branch index number on vivitainc/ViviParts.git</div>
<div class="line"> </div>
<div class="line">const dcInfo_t dcInfo[] = {</div>
<div class="line">  // {group_no, data_nature, data_type, data_min, data_max}</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_LIGHT_R,</div>
<div class="line">   DEFAULT_LIGHT}, // 1: Red</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_LIGHT_G,</div>
<div class="line">   DEFAULT_LIGHT}, // 2: Green</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_LIGHT_B,</div>
<div class="line">   DEFAULT_LIGHT}, // 3: Blue</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">static const int pins[N_RGB] = {</div>
<div class="line">  LED_R_PIN,</div>
<div class="line">  LED_G_PIN,</div>
<div class="line">  LED_B_PIN,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">static uint16_t lights[N_RGB] = {</div>
<div class="line">  DEFAULT_LIGHT,</div>
<div class="line">  DEFAULT_LIGHT,</div>
<div class="line">  DEFAULT_LIGHT,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">static inline void analogWrite_(const int pin, const uint16_t value) {</div>
<div class="line">  const uint16_t max_value =</div>
<div class="line">#if defined(BOARD_REV) &amp;&amp; (BOARD_REV &gt;= BOARD_REV_FP1_DVT)</div>
<div class="line">    (pin == LED_B_PIN) ? MAX_LIGHT_8BIT : MAX_LIGHT_16BIT;</div>
<div class="line">#else</div>
<div class="line">    (pin == LED_R_PIN) ? MAX_LIGHT_8BIT : MAX_LIGHT_16BIT;</div>
<div class="line">#endif</div>
<div class="line">  const bool is_max = (value == max_value);</div>
<div class="line"> </div>
<div class="line">  if (value == 0) {</div>
<div class="line">    digitalWrite(pin, LOW);</div>
<div class="line">  } else if (is_max) {</div>
<div class="line">    digitalWrite(pin, HIGH);</div>
<div class="line">  } else {</div>
<div class="line">#if defined(BOARD_REV) &amp;&amp; (BOARD_REV &gt;= BOARD_REV_FP1_DVT)</div>
<div class="line">    if (pin == LED_R_PIN) {</div>
<div class="line">#else</div>
<div class="line">    if (pin == LED_B_PIN) {</div>
<div class="line">#endif</div>
<div class="line">      bitSet(TCCR1A, COM1A1);</div>
<div class="line">      OCR1A = value;</div>
<div class="line">    } else if (pin == LED_G_PIN) {</div>
<div class="line">      bitSet(TCCR1A, COM1B1);</div>
<div class="line">      OCR1B = value;</div>
<div class="line">#if defined(BOARD_REV) &amp;&amp; (BOARD_REV &gt;= BOARD_REV_FP1_DVT)</div>
<div class="line">    } else if (pin == LED_B_PIN) {</div>
<div class="line">#else</div>
<div class="line">    } else if (pin == LED_R_PIN) {</div>
<div class="line">#endif</div>
<div class="line">      bitSet(TCCR2A, COM2B1);</div>
<div class="line">      OCR2B = (uint8_t)value;</div>
<div class="line">    } else {</div>
<div class="line">      // do nothing</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void correctGamma(const uint16_t *rgb_in, uint16_t *rgb_out) {</div>
<div class="line">  static const uint16_t max_lights[N_RGB] = {</div>
<div class="line">    MAX_LIGHT_R,</div>
<div class="line">    MAX_LIGHT_G,</div>
<div class="line">    MAX_LIGHT_B,</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; N_RGB; i++) {</div>
<div class="line">    rgb_out[i] = (uint16_t)roundf((float)max_lights[i] * pow((float)rgb_in[i] / (float)max_lights[i], EXP_GAMMA));</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void analogWriteGamma(const uint16_t *rgb_in) {</div>
<div class="line">  uint16_t rgb_out[N_RGB] = {};</div>
<div class="line">  correctGamma(rgb_in, rgb_out);</div>
<div class="line">  for (uint8_t i = 0; i &lt; N_RGB; i++) {</div>
<div class="line">    analogWrite_(pins[i], rgb_out[i]);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  Vivicore.begin(BRANCH_TYPE, USER_FW_VER, dcInfo, countof(dcInfo), MIN_LIBRARY_VER_BUILD_NO);</div>
<div class="line"> </div>
<div class="line">  pinMode(LED_VCC_PIN, OUTPUT);</div>
<div class="line">  for (uint8_t i = 0; i &lt; N_RGB; i++) {</div>
<div class="line">    pinMode(pins[i], OUTPUT);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  TCCR3A = bit(COM3B1) | bit(WGM31);            // no inverting, OC3B only connected</div>
<div class="line">  TCCR3B = bit(WGM33) | bit(WGM32) | bit(CS30); // fast PWM, TOP=ICR3, no prescaling</div>
<div class="line">  ICR3   = F_CPU / LED_VCC_HZ;                  // TOP counter value</div>
<div class="line">  OCR3B  = F_CPU / LED_VCC_HZ / 2;              // OC3B (D2/PD2) only output with duty cycle 50%</div>
<div class="line">  bitSet(PORTD,</div>
<div class="line">         2); // When not using the Output Compare Modulator, PORTD2 must also be set in order to enable the output.</div>
<div class="line"> </div>
<div class="line">  TCCR1A = bit(COM1A1) | bit(COM1B1) | bit(WGM11); // no inverting, OC1A and OC1B connected</div>
<div class="line">  TCCR1B = bit(WGM13) | bit(WGM12) | bit(CS10);    // fast PWM, TOP=ICR1, no prescaling</div>
<div class="line">  ICR1   = MAX_LIGHT_16BIT;                        // TOP counter value for 1kHz</div>
<div class="line"> </div>
<div class="line">  TCCR2A = bit(COM2B1) | bit(WGM21) | bit(WGM20); // no inverting, OC2B only connected, fast PWM, TOP=0xFF</div>
<div class="line">  TCCR2B = bit(CS21); // clk/8 prescaling for about 4kHz higher frequency than another 16bit timers</div>
<div class="line"> </div>
<div class="line">  analogWriteGamma(lights);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  const AvailableNum_t cnt = Vivicore.available();</div>
<div class="line"> </div>
<div class="line">  delay(10);</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; cnt.scaler; i++) {</div>
<div class="line">    const ScalerData_t scaler = Vivicore.read();</div>
<div class="line">    if (scaler.success &amp;&amp; (0 &lt; scaler.dc_n) &amp;&amp; (scaler.dc_n &lt;= N_RGB)) {</div>
<div class="line">      const uint8_t rgb = scaler.dc_n - 1;</div>
<div class="line">      lights[rgb]       = static_cast&lt;uint16_t&gt;(scaler.data);</div>
<div class="line">    }</div>
<div class="line">    DebugPlainPrint0(&quot;dc_n:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.dc_n);</div>
<div class="line">    DebugPlainPrint0(&quot;, success:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.success);</div>
<div class="line">    DebugPlainPrint0(&quot;, data:&quot;);</div>
<div class="line">    DebugPlainPrintln0(scaler.data);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  if (cnt.scaler &gt; 0) {</div>
<div class="line">    analogWriteGamma(lights);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>

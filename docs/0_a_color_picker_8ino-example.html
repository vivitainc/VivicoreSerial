<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VivicoreSerial library: 0A_color_picker.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">VivicoreSerial library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">0A_color_picker.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#define MIN_LIBRARY_VER_BUILD_NO (0x0012)</div>
<div class="line">#include &lt;VivicoreSerial.h&gt;</div>
<div class="line">#include &lt;Adafruit_APDS9960.h&gt;</div>
<div class="line"> </div>
<div class="line">#define MAX_HUE       (359)</div>
<div class="line">#define MAX_SAT       (255)</div>
<div class="line">#define MAX_VAL       (255)</div>
<div class="line">#define LIGHT_FACTOR  (10)</div>
<div class="line">#define MAX_LIGHT     (255 * LIGHT_FACTOR)</div>
<div class="line">#define DEFAULT_LIGHT (MAX_LIGHT * 3 / 10)</div>
<div class="line">#define VCC_HZ        (32 * 1000)</div>
<div class="line">#define COLORS        (8 + 2) // Color number + origin + end point</div>
<div class="line"> </div>
<div class="line">#define VCC_PIN (9)</div>
<div class="line">#define LED_PIN (3)</div>
<div class="line"> </div>
<div class="line">enum {</div>
<div class="line">  RGB_R = 0,</div>
<div class="line">  RGB_G,</div>
<div class="line">  RGB_B,</div>
<div class="line">  RGB_NUM,</div>
<div class="line">};</div>
<div class="line">enum {</div>
<div class="line">  HSV_H = 0,</div>
<div class="line">  HSV_S,</div>
<div class="line">  HSV_V,</div>
<div class="line">  HSV_NUM,</div>
<div class="line">};</div>
<div class="line">enum {</div>
<div class="line">  DC_HUE = 1,</div>
<div class="line">  DC_SATURATION,</div>
<div class="line">  DC_VALUE,</div>
<div class="line">  DC_LED,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">const uint8_t  USER_FW_MAJOR_VER = 0x00;</div>
<div class="line">const uint8_t  USER_FW_MINOR_VER = 0x12;</div>
<div class="line">const uint16_t USER_FW_VER       = (((uint16_t)(USER_FW_MAJOR_VER) &lt;&lt; 8) + ((uint16_t)(USER_FW_MINOR_VER)));</div>
<div class="line">const uint32_t BRANCH_TYPE       = 0x0000000A; // Branch index number on vivitainc/ViviParts.git</div>
<div class="line"> </div>
<div class="line">const dcInfo_t dcInfo[] = {</div>
<div class="line">  // {group_no, data_nature, data_type, data_min, data_max, data_ini}</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_HUE}, // 1: Hue</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_SAT}, // 2: Saturation</div>
<div class="line">  {DcGroup_t::DC_GROUP_1, DcNature_t::DC_NATURE_OUT, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_VAL}, // 3: Value</div>
<div class="line">  {DcGroup_t::DC_GROUP_2, DcNature_t::DC_NATURE_IN, DcType_t::DC_TYPE_ANALOG_2BYTES, 0, MAX_LIGHT,</div>
<div class="line">   DEFAULT_LIGHT}, // 4: Light LED</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">// Color conversion table written on this esa.</div>
<div class="line">// https://vivita.esa.io/posts/6726#%E8%89%B2%E7%A7%BB%E5%8B%95</div>
<div class="line">static const long h_in[COLORS] = {</div>
<div class="line">  0, 31, 51, 95, 198, 224, 280, 320, 356, 359,</div>
<div class="line">};</div>
<div class="line">static const long h_out[COLORS] = {</div>
<div class="line">  0, 29, 50, 122, 191, 237, 283, 323, 357, 359,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">Adafruit_APDS9960 apds9960;</div>
<div class="line"> </div>
<div class="line">static inline float mapf(const float x, const float in_min, const float in_max, const float out_min,</div>
<div class="line">                         const float out_max) {</div>
<div class="line">  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void analogWriteToLed(const uint16_t value) {</div>
<div class="line">  if (value == 0) {</div>
<div class="line">    digitalWrite(LED_PIN, LOW);</div>
<div class="line">  } else if (value == MAX_LIGHT) {</div>
<div class="line">    digitalWrite(LED_PIN, HIGH);</div>
<div class="line">  } else {</div>
<div class="line">    // uint8_t rawVal = (uint8_t)roundf((float)value / (float)LIGHT_FACTOR); // More accurate</div>
<div class="line">    uint8_t rawVal = (uint8_t)(value / LIGHT_FACTOR);</div>
<div class="line">    bitSet(TCCR2A, COM2B1);</div>
<div class="line">    OCR2B = rawVal;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline uint16_t convertHue(const uint16_t hue) {</div>
<div class="line">  uint8_t index = 0;</div>
<div class="line"> </div>
<div class="line">  for (index = 0; index &lt; COLORS - 1; index++) {</div>
<div class="line">    if (h_in[index] &lt;= hue &amp;&amp; hue &lt;= h_in[index + 1]) {</div>
<div class="line">      break;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return (uint16_t)map(hue, h_in[index], h_in[index + 1], h_out[index], h_out[index + 1]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline float convertHue(const float hue) {</div>
<div class="line">  uint8_t index = 0;</div>
<div class="line"> </div>
<div class="line">  for (index = 0; index &lt; COLORS - 1; index++) {</div>
<div class="line">    if ((float)h_in[index] &lt;= hue &amp;&amp; hue &lt;= (float)h_in[index + 1]) {</div>
<div class="line">      break;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  return mapf(hue, (float)h_in[index], (float)h_in[index + 1], (float)h_out[index], (float)h_out[index + 1]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline uint16_t convertRoundedHue(const uint16_t hue) {</div>
<div class="line">  return roundf(convertHue((float)hue));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void convertHsv(const uint16_t *rgb_raw, uint16_t *hsv) {</div>
<div class="line">  static const float darkc[RGB_NUM] = {</div>
<div class="line">    96.0,</div>
<div class="line">    360.0,</div>
<div class="line">    284.0,</div>
<div class="line">  };</div>
<div class="line">  static const float to_non_interfer[RGB_NUM][RGB_NUM] = {</div>
<div class="line">    {1.60, -0.40, -0.03},</div>
<div class="line">    {-0.10, 1.55, -0.45},</div>
<div class="line">    {-0.24, -0.60, 1.50},</div>
<div class="line">  };</div>
<div class="line">  static const float gc_div[RGB_NUM] = {</div>
<div class="line">    5000.0,</div>
<div class="line">    6000.0,</div>
<div class="line">    5000.0,</div>
<div class="line">  };</div>
<div class="line">  static const float gc_offset[RGB_NUM] = {</div>
<div class="line">    22.0,</div>
<div class="line">    29.0,</div>
<div class="line">    26.0,</div>
<div class="line">  };</div>
<div class="line">  int16_t hue                = 0;</div>
<div class="line">  float   rgb_darkc[RGB_NUM] = {};</div>
<div class="line">  float   rgb[RGB_NUM]       = {};</div>
<div class="line">  int16_t rgb_gc[RGB_NUM]    = {};</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; RGB_NUM; i++) {</div>
<div class="line">    rgb_darkc[i] = (float)rgb_raw[i] - darkc[i];</div>
<div class="line">    if (rgb_darkc[i] &lt; 0.0) {</div>
<div class="line">      rgb_darkc[i] = 0.0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; RGB_NUM; i++) {</div>
<div class="line">    const float *row = to_non_interfer[i];</div>
<div class="line">    for (uint8_t j = 0; j &lt; RGB_NUM; j++) {</div>
<div class="line">      rgb[i] += row[j] * rgb_darkc[j];</div>
<div class="line">    }</div>
<div class="line">    rgb[i]    = constrain(rgb[i], 0.0, 10000.0);</div>
<div class="line">    rgb_gc[i] = (int16_t)constrain(255.0 * pow(rgb[i] / gc_div[i], 0.35) - gc_offset[i], 0.0, 255.0);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  const int16_t max_ = max(rgb_gc[RGB_R], max(rgb_gc[RGB_G], rgb_gc[RGB_B]));</div>
<div class="line">  const int16_t min_ = min(rgb_gc[RGB_R], min(rgb_gc[RGB_G], rgb_gc[RGB_B]));</div>
<div class="line">  hsv[HSV_S]         = (uint8_t)((max_) ? (255L * (max_ - min_) / max_) : 0);</div>
<div class="line">  hsv[HSV_V]         = (uint8_t)max_;</div>
<div class="line"> </div>
<div class="line">  if (max_ == min_) {</div>
<div class="line">    hue = 0;</div>
<div class="line">  } else if (max_ == rgb_gc[RGB_R]) {</div>
<div class="line">    hue = 60L * (rgb_gc[RGB_G] - rgb_gc[RGB_B]) / (max_ - min_);</div>
<div class="line">  } else if (max_ == rgb_gc[RGB_G]) {</div>
<div class="line">    hue = 60L * (rgb_gc[RGB_B] - rgb_gc[RGB_R]) / (max_ - min_) + 120;</div>
<div class="line">  } else {</div>
<div class="line">    hue = 60L * (rgb_gc[RGB_R] - rgb_gc[RGB_G]) / (max_ - min_) + 240;</div>
<div class="line">  }</div>
<div class="line">  if (hue &lt; 0) {</div>
<div class="line">    hue += 360;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  hsv[HSV_H] = (uint16_t)hue;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">static inline void controlLed(void) {</div>
<div class="line">  const AvailableNum_t cnt = Vivicore.available();</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; cnt.scaler; i++) {</div>
<div class="line">    const ScalerData_t scaler = Vivicore.read();</div>
<div class="line">    if (scaler.success &amp;&amp; (scaler.dc_n == DC_LED)) {</div>
<div class="line">      analogWriteToLed(static_cast&lt;uint16_t&gt;(scaler.data));</div>
<div class="line">    }</div>
<div class="line">    DebugPlainPrint0(&quot;dc_n:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.dc_n);</div>
<div class="line">    DebugPlainPrint0(&quot;, success:&quot;);</div>
<div class="line">    DebugPlainPrint0(scaler.success);</div>
<div class="line">    DebugPlainPrint0(&quot;, data:&quot;);</div>
<div class="line">    DebugPlainPrintln0(scaler.data);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  Vivicore.begin(BRANCH_TYPE, USER_FW_VER, dcInfo, countof(dcInfo), MIN_LIBRARY_VER_BUILD_NO);</div>
<div class="line">  if (apds9960.begin()) {</div>
<div class="line">    apds9960.enableColor(true);</div>
<div class="line">    apds9960.setADCGain(APDS9960_AGAIN_64X);</div>
<div class="line">    // arg type is uint16_t and calclate ATIME reg value like below internally</div>
<div class="line">    // ATIME reg: 256 - (iTimeMS / 2.78)</div>
<div class="line">    apds9960.setADCIntegrationTime(28);</div>
<div class="line">  } else {</div>
<div class="line">    DebugPlainPrintln0(&quot;Error: initialization&quot;);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  pinMode(VCC_PIN, OUTPUT);</div>
<div class="line">  pinMode(LED_PIN, OUTPUT);</div>
<div class="line"> </div>
<div class="line">  TCCR1A = bit(COM1A1) | bit(WGM11);            // no inverting, OC1A only connected</div>
<div class="line">  TCCR1B = bit(WGM13) | bit(WGM12) | bit(CS10); // fast PWM, TOP=ICR1, no prescaling</div>
<div class="line">  ICR1   = F_CPU / VCC_HZ;                      // TOP counter value for 32kHz</div>
<div class="line">  OCR1A  = F_CPU / VCC_HZ / 2;                  // OC1A (D9/PB1) only output with duty cycle 50%</div>
<div class="line"> </div>
<div class="line">  TCCR2A = bit(COM2B1) | bit(WGM21) | bit(WGM20); // no inverting, OC2B only connected, fast PWM, TOP=0xFF</div>
<div class="line">  TCCR2B = bit(CS21);                             // clk/8 prescaling for about 4kHz</div>
<div class="line">  analogWriteToLed(DEFAULT_LIGHT);                // OC2B (D3/PD3) only output</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  static uint16_t hsv_prev[HSV_NUM] = {};</div>
<div class="line">  uint16_t        hue               = 0;</div>
<div class="line">  uint16_t        hsv[HSV_NUM]      = {};</div>
<div class="line">  uint16_t        rgb[RGB_NUM]      = {};</div>
<div class="line">  uint16_t        c                 = 0;</div>
<div class="line"> </div>
<div class="line">  delay(30);</div>
<div class="line">  controlLed();</div>
<div class="line"> </div>
<div class="line">  while (!apds9960.colorDataReady()) {</div>
<div class="line">    delay(5);</div>
<div class="line">  }</div>
<div class="line">  apds9960.getColorData(&amp;rgb[RGB_R], &amp;rgb[RGB_G], &amp;rgb[RGB_B], &amp;c);</div>
<div class="line"> </div>
<div class="line">  convertHsv(rgb, hsv);</div>
<div class="line">  hue        = hsv[HSV_H];</div>
<div class="line">  hsv[HSV_H] = convertRoundedHue(hue);</div>
<div class="line"> </div>
<div class="line">  for (uint8_t i = 0; i &lt; HSV_NUM; i++) {</div>
<div class="line">    if (hsv_prev[i] != hsv[i]) {</div>
<div class="line">      const uint8_t dc_num = i + 1;</div>
<div class="line">      hsv_prev[i]          = hsv[i];</div>
<div class="line">      Vivicore.write(dc_num, hsv[i]);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  Vivicore.flush();</div>
<div class="line"> </div>
<div class="line">  DebugPlainPrint0(&quot;raw:&quot;);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_R] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_R]);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_G] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_G]);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_B] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(rgb[RGB_B]);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(c &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(c);</div>
<div class="line">  DebugPlainPrintln0(&quot;&quot;);</div>
<div class="line">  DebugPlainPrint0(&quot;hsv:&quot;);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_H] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_H]);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_S] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_S]);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_V] &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(hsv[HSV_V]);</div>
<div class="line">  DebugPlainPrintln0(&quot;&quot;);</div>
<div class="line">  DebugPlainPrint0(&quot;hue:&quot;);</div>
<div class="line">  DebugHexPrint0(hue &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(hue);</div>
<div class="line">  DebugPlainPrint0(&quot;,&quot;);</div>
<div class="line">  DebugHexPrint0(convertHue(hue) &gt;&gt; 8);</div>
<div class="line">  DebugHexPrint0(convertHue(hue));</div>
<div class="line">  DebugPlainPrintln0(&quot;&quot;);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
